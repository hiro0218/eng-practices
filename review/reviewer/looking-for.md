# コードレビューで注目すべき点

注: これらのポイントを考慮する際には、常に[コードレビューの基準](standard.md)を考慮してください。

## 設計

レビューで最も重要な点は、CL（変更リスト）の全体的な設計です。
CL内の各コードの相互作用は理にかなっていますか？
この変更はあなたのコードベースに適しているのか、それともライブラリに適していますか？
システム全体とよく統合されていますか？
今、この機能を追加するのは良いタイミングですか？

## 機能性

このCLは、開発者が意図した通りに機能していますか？
開発者が意図したものは、このコードのユーザーにとって有用ですか？
「ユーザー」とは通常、エンドユーザー（変更に影響を受ける場合）と開発者（将来このコードを「使用」する人）の両方を指します。

大抵の場合、開発者はCLがコードレビューに到達するまでに十分にテストを行い、正しく動作するようにしています。
しかし、レビュアーとしては、エッジケースについて考え、並行処理の問題を探し、ユーザーのように考え、コードを読むだけでバグがないか確認する必要があります。

**UIの変更**のように、ユーザーに直接影響を与える場合、レビュアーがCLの動作を確認することが最も重要です。
コードを読んでいるだけでは、一部の変更がユーザーにどのような影響を与えるかを理解するのは難しいです。
そのような変更については、CLをパッチして自分で試すのが不便な場合、開発者に機能のデモをしてもらうことができます。

また、CL内で**並行プログラミング**が行われている場合、デッドロックや競合状態が理論的に発生する可能性がある場合、機能性について特に考える必要があります。
このような問題は、コードを実行するだけでは非常に検出しにくく、通常は誰か（開発者とレビュアーの両方）が慎重に考える必要があります。
（これは、競合状態やデッドロックが可能な並行モデルを使用しないようにするもう一つの良い理由でもあります。それにより、コードレビューを行ったり、コードを理解したりするのが非常に複雑になります。）

## 複雑さ

CLは必要以上に複雑ですか？
この点は、CLの各レベルで確認してください。
個々の行は複雑すぎますか？
関数は複雑すぎますか？
クラスは複雑すぎますか？
「複雑すぎる」とは通常、**「コードの読者がすぐに理解できない」**ことを意味します。
また、**「開発者がこのコードを呼び出すか修正する際にバグを導入する可能性が高い」**とも言えます。

特定のタイプの複雑さは**過度な設計（オーバーエンジニアリング）**です。
開発者がコードを必要以上に一般的にしていたり、現在のシステムには必要のない機能を追加していたりする場合です。
レビュアーは、過度な設計に特に注意を払う必要があります。
開発者に、現在解決する必要があると確信している問題を解決するように促してください。
未来に解決する必要があるかもしれないと開発者が推測する問題は、その問題が実際に到来し、その実際の形と要件が物理的な宇宙で見えるようになったら解決してください。

## テスト

変更に適したユニットテスト、統合テスト、またはエンドツーエンドテストを要求してください。
一般に、テストは緊急事態を処理している場合を除き、本番コードと同じCLに追加されるべきです。

CL内のテストが正確で、理にかなっており、有用であることを確認してください。
テスト自体は自分自身をテストするわけではありませんし、私たちはほとんどテストのためのテストを書きません。
人間がテストが有効であることを確認する必要があります。

テストは、コードが壊れたときに実際に失敗しますか？
コードが下で変更された場合、テストは偽陽性を出すようになりますか？
各テストはシンプルで有用なアサーションを行っていますか？
テストは、異なるテストメソッドの間で適切に分離されていますか？

テストもメンテナンスが必要なコードであることを忘れないでください。
主要なバイナリの一部でないからといって、テストでの複雑さを受け入れないでください。

## 名前付け

開発者はすべてに対して良い名前を選びましたか？
良い名前とは、項目が何であるか、または何をするかを完全に伝えるのに十分な長さであり、読むのが難しくなるほど長くはありません。

## コメント

開発者は理解しやすい英語で明確なコメントを書きましたか？
すべてのコメントが実際に必要ですか？
通常、コメントはコードが存在する**理由**を説明する際に有用であり、コードが**何をしているのか**を説明している場合はありません。
コードが自体を説明するのに十分に明確でない場合、コードをよりシンプルにする必要があります。
例外もありますが（正規表現や複雑なアルゴリズムは、何をしているのかを説明するコメントが非常に有益であることが多いです）、ほとんどの場合、コメントはコード自体が絶対に含むことができない情報、つまり決定の背後にある推論のためにあります。

このCLより前のコメントも見ると役立つ場合があります。
たとえば、この変更を行うことに対する警告をするコメントがあるか、TODOが今削除できるかなどです。

コメントは、クラス、モジュール、または関数の**文書化**とは異なります。
文書化は、コードの一部の目的、使用方法、使用時の動作を表現するべきです。

## スタイル

Googleでは、主要な言語すべて、さらにはほとんどのマイナーな言語に対しても[スタイルガイド](http://google.github.io/styleguide/)があります。
CLが適切なスタイルガイドに従っていることを確認してください。

スタイルガイドにないスタイルポイントを改善したい場合は、コメントの先頭に「Nit:」と付けて、それが細かい指摘であり、コードを改善すると思うが必須ではないと開発者に知らせてください。
個人的なスタイルの好みだけに基づいてCLの提出をブロックしないでください。

CLの著者は、他の変更と組み合わせて主要なスタイルの変更を含めるべきではありません。
これは、CLで何が変更されているのかを見るのが難しくなるだけでなく、マージやロールバックがより複雑になり、他の問題も引き起こします。
たとえば、著者がファイル全体を再フォーマットしたい場合、まずその再フォーマットだけを1つのCLとして送り、その後に機能的な変更を別のCLで送ってもらってください。

## 一貫性

既存のコードがスタイルガイドと一貫性がない場合はどうすればよいですか？
私たちの[コードレビューの原則](standard.md#principles)によれば、スタイルガイドは絶対的な権威です。
スタイルガイドで何かが必要とされている場合、CLはそのガイドラインに従うべきです。

場合によっては、スタイルガイドは推奨事項を提供するだけで、要件を宣言しないことがあります。
このような場合、新しいコードが推奨事項と一致するか、周囲のコードと一致するかは判断の問題です。
地元の不一致があまりにも混乱を招くようであれば、スタイルガイドに従う傾向があります。

他のルールが適用されない場合、著者は既存のコードと一貫性を維持すべきです。

いずれにせよ、著者に既存のコードをクリーンアップするためのバグを登録し、TODOを追加するように促してください。

## 文書化

CLがユーザーがコードをビルド、テスト、対話、リリースする方法を変更する場合、関連する文書も更新しているか確認してください。
これにはREADME、g3docのページ、生成された参照ドキュメントなどが含まれます。
CLがコードを削除または非推奨にする場合、文書も削除する必要があるかもしれません。
文書が不足している場合は、それを要求してください。

## すべての行 {#every-line}

一般的なケースでは、レビューが割り当てられた**すべての行**のコードを見てください。
データファイル、生成されたコード、または大きなデータ構造などは時々スキャンできますが、人が書いたクラス、関数、またはコードブロックをスキャンして、その中が大丈夫だと仮定しないでください。
明らかに一部のコードは他のコードよりも慎重な精査が必要ですが、少なくともすべてのコードが何をしているのかを**理解**していることを確認してください。

コードを読むのがあまりにも困難で、レビューが遅れている場合は、開発者にそのことを知らせて、それを明確にするまでレビューを待ってください。
Googleでは優れたソフトウェアエンジニアを採用しています、そしてあなたもその一人です。
あなたがコードを理解できないなら、他の開発者も同様に理解できない可能性が非常に高いです。
ですので、開発者にそれを明確にするように頼むことで、将来の開発者もこのコードを理解する助けとなります。

コードを理解しているが、レビューの一部を行う資格がないと感じる場合は、特にプライバシー、セキュリティ、並行処理、アクセシビリティ、国際化などの複雑な問題に対して、CLに資格のあるレビュアーがいることを確認してください。

### 例外 {#every-line-exceptions}

すべての行をレビューすることが意味をなさない場合はどうすればよいですか？
たとえば、あなたはCLの複数のレビュアーの一人であり、以下のように求められる場合があります。

*   大きな変更の一部である特定のファイルだけをレビューする。
*   CLの特定の側面だけをレビューする、例えば高レベルの設計、プライバシーやセキュリティの影響など。

これらの場合、どの部分をレビューしたかをコメントで明示してください。
[コメント付きでLGTMを与える](speed.md#lgtm-with-comments)ことを好みます。

代わりに、他のレビュアーがCLの他の部分をレビューしたことを確認した後でLGTMを付与したい場合は、このことを明示的にコメントで示して期待値を設定してください。
CLが望ましい状態に達したら、[迅速に応答](speed.md#responses)するように目指してください。

## 文脈

CLを広い文脈で見ることはしばしば有用です。
通常、コードレビューツールは変更されている部分の周囲に数行のコードしか表示しません。
変更が実際に意味を成すためには、全体のファイルを確認する必要がある場合もあります。
たとえば、4行の新しい行が追加されているだけかもしれませんが、全体のファイルを見ると、それらの4行が今は小さなメソッドに分割されるべき50行のメソッドにあることに気付くかもしれません。

また、CLをシステム全体の文脈で考えることも有用です。
このCLはシステムのコードヘルスを向上させていますか、それともシステム全体をより複雑にし、よりテストされていない状態にしていますか？
**システムのコードヘルスを劣化させるCLを受け入れてはいけません。**
ほとんどのシステムは、累積する多くの小さな変更によって複雑になるため、新しい変更でも小さな複雑さを防ぐことが重要です。

## 良い点 {#good-things}

CLで何か良い点を見つけた場合、特に自分のコメントに素晴らしい方法で対応した場合は、開発者に伝えてください。
コードレビューはよく間違いに焦点を当てがちですが、良い実践に対する励ましと感謝も提供するべきです。
指導する上で、開発者が何を間違っていたかを伝えるよりも、何を正しくしたかを伝えることが時にはさらに価値があることもあります。

## まとめ

コードレビューを行う際には、以下を確認してください。

-   コードはよく設計されている。
-   機能性は、このコードのユーザーにとって良い。
-   UIの変更が理にかなっており、ユーザーに有益である。
-   並行プログラムの問題が特に考慮されている。
-   コードは複雑すぎない。
-   良い名前とコメントが使われている。
-   コードはスタイルガイドに従っている。
-   文書化が適切である。

そして最後に、CLがシステム全体のコードヘルスを向上させていることを確認してください。
